@* Dialog lọc *@
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="filterModalLabel"><i class="fas fa-filter me-2"></i>Lọc nâng cao</h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <!-- Lọc theo loại -->
                    <div class="col-md-6 border rounded p-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="filterTypeEnabled">
                            <label class="form-check-label fw-bold text-primary" for="filterTypeEnabled">
                                Lọc theo loại giao dịch
                            </label>
                        </div>
                        <select id="typeSelect" name="type" class="form-select" disabled>
                            <option value="">Tất cả</option>
                            <option value="Income">Thu</option>
                            <option value="Expense">Chi</option>
                        </select>
                    </div>

                    <!-- Lọc theo tuần -->
                    <div class="col-md-6 border rounded p-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="filterQuickDateEnabled">
                            <label class="form-check-label fw-bold text-primary" for="filterQuickDateEnabled">
                                Lọc nhanh theo thời gian
                            </label>
                        </div>
                        <select id="quickDateSelect" name="quickDate" class="form-select" disabled>
                            <option value="">-- Chọn --</option>
                            <option value="today">Hôm nay</option>
                            <option value="thisWeek">Tuần này</option>
                            <option value="thisMonth">Tháng này</option>
                            <option value="thisYear">Năm này</option>
                        </select>
                    </div>

                    <!-- Khoảng tiền -->
                    <div class="col-md-6 border rounded p-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="filterAmountEnabled">
                            <label class="form-check-label fw-bold text-primary" for="filterAmountEnabled">
                                Lọc theo khoảng tiền
                            </label>
                        </div>
                        <div class="range-slider-container" style="display: none;">
                            <div class="range-slider position-relative">
                                <input type="range" class="form-range range-slider__range" min="0" max="100000000" step="100000"
                                       id="amountRangeFrom" oninput="updateAmountLabels()" disabled>
                                <input type="range" class="form-range range-slider__range" min="0" max="100000000" step="100000"
                                       id="amountRangeTo" oninput="updateAmountLabels()" disabled>
                            </div>
                            <div class="range-labels d-flex justify-content-between mt-2">
                                <small>Từ: <span id="amountLabelFrom">0</span> đ</small>
                                <small>Đến: <span id="amountLabelTo">0</span> đ</small>
                            </div>
                            <input type="hidden" id="amountFrom" name="amountFrom" value="0" />
                            <input type="hidden" id="amountTo" name="amountTo" value="100000000" />
                        </div>
                    </div>



                    <!-- Ngày từ / đến -->
                    <div class="col-md-6 border rounded p-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="filterDateEnabled">
                            <label class="form-check-label fw-bold text-primary" for="filterDateEnabled">
                                Lọc theo khoảng ngày
                            </label>
                        </div>
                        <div class="row g-2">
                            <div class="col">
                                <input type="date" id="fromDate" name="fromDate" class="form-control" disabled />
                            </div>
                            <div class="col">
                                <input type="date" id="toDate" name="toDate" class="form-control" disabled />
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Áp dụng lọc</button>
            </div>
        </div>
    </div>
</div>

<style>
    .range-slider {
        position: relative;
        height: 40px;
    }

    .range-slider__range {
        position: absolute;
        width: 100%;
        pointer-events: none;
        -webkit-appearance: none;
        background: transparent;
    }

        .range-slider__range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5e72e4;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            pointer-events: auto;
            position: relative;
            z-index: 2;
        }

        .range-slider__range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5e72e4;
            border: 2px solid white;
            cursor: pointer;
            pointer-events: auto;
            z-index: 2;
        }

    .range-labels small {
        font-weight: bold;
    }

</style>

<script>
    $(document).ready(function () {
        // tick bộ lọc
        $('#filterTypeEnabled').change(function () {
            $('#typeSelect').prop('disabled', !this.checked);
        });

        $('#filterAmountEnabled').change(function () {
            const isChecked = this.checked;
            $('#amountRangeFrom, #amountRangeTo').prop('disabled', !isChecked);
            $('.range-slider-container').toggle(isChecked);

            if (isChecked) {
                // Khởi tạo giá trị mặc định
                $('#amountRangeFrom').val(0);
                $('#amountRangeTo').val(100000000);
                updateAmountLabels();
            }
        });

        $('#filterDateEnabled').change(function () {
            const isChecked = this.checked;
            $('#fromDate, #toDate').prop('disabled', !isChecked);

            if (isChecked) {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

                // Chuyển định dạng sang yyyy-MM-dd để gán vào input type="date"
                const formatDate = date => date.toISOString().split('T')[0];

                $('#fromDate').val(formatDate(firstDay));
                $('#toDate').val(formatDate(today));
            } else {
                // Nếu bỏ chọn thì xóa giá trị
                $('#fromDate').val('');
                $('#toDate').val('');
            }
        });


        $('#filterQuickDateEnabled').change(function () {
            $('#quickDateSelect').prop('disabled', !this.checked);
        });


        // Khởi tạo range slider
        initializeRangeSlider();
    });

    function initializeRangeSlider() {
        const fromSlider = document.getElementById('amountRangeFrom');
        const toSlider = document.getElementById('amountRangeTo');

        const minGap = 1000000; // Khoảng tối thiểu giữa 2 điểm

        fromSlider.addEventListener('input', function () {
            let fromValue = parseInt(fromSlider.value);
            let toValue = parseInt(toSlider.value);

            if (fromValue + minGap > toValue) {
                fromSlider.value = toValue - minGap;
                fromValue = parseInt(fromSlider.value);
            }

            updateAmountLabels();
        });

        toSlider.addEventListener('input', function () {
            let fromValue = parseInt(fromSlider.value);
            let toValue = parseInt(toSlider.value);

            if (toValue - minGap < fromValue) {
                toSlider.value = fromValue + minGap;
                toValue = parseInt(toSlider.value);
            }

            updateAmountLabels();
        });
    }


    function updateAmountLabels() {
        const fromValue = parseInt($('#amountRangeFrom').val());
        const toValue = parseInt($('#amountRangeTo').val());

        $('#amountLabelFrom').text(fromValue.toLocaleString('vi-VN'));
        $('#amountLabelTo').text(toValue.toLocaleString('vi-VN'));

        $('#amountFrom').val(fromValue);
        $('#amountTo').val(toValue);
    }

    function applyFilters() {
        // Lấy dữ liệu từ form search chính
        const formData = new FormData(document.getElementById('formSearch'));

        // Thêm các filter mới
        if ($('#filterTypeEnabled').is(':checked')) {
            formData.set('Type', $('#typeSelect').val());
        }

        if ($('#filterAmountEnabled').is(':checked')) {
            formData.set('AmountFrom', $('#amountFrom').val());
            formData.set('AmountTo', $('#amountTo').val());
        }

        if ($('#filterDateEnabled').is(':checked')) {
            formData.set('FromDate', $('#fromDate').val());
            formData.set('ToDate', $('#toDate').val());
        }

        if ($('#filterQuickDateEnabled').is(':checked')) {
            formData.set('QuickDate', $('#quickDateSelect').val());
        }

        // Chuyển FormData thành object
        const searchData = {};
        for (let [key, value] of formData.entries()) {
            searchData[key] = value;
        }

        // Gọi function doSearch từ trang chính
        if (typeof doSearch === 'function') {
            doSearch(1, searchData);
        }

        // Đóng modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('filterModal'));
        if (modal) {
            modal.hide();
        }
    }
</script> 