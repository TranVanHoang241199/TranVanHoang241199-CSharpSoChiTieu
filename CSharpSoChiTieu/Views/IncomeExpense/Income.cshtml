@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
	ViewData["Title"] = "Thêm Khoản Thu";
}

<div class="card mb-4 shadow-sm">
	<div class="card-header pb-2 px-3">
		<h6 class="mb-0 text-success"><i class="fas fa-plus-circle me-2"></i>@ViewBag.Title</h6>
	</div>
	<div class="card-body p-3">
		<form id="addIncomeForm" class="needs-validation" novalidate>
			<!-- Ngày thu -->
			<div class="d-flex align-items-center mb-3">
				<label for="income-date" class="form-label small fw-bold mb-0 me-3 text-nowrap flex-shrink-0" style="width: 70px;">Ngày thu <span class="text-danger">*</span></label>
				<div class="input-group input-group-static flex-grow-1">
					<span class="input-group-text"><i class="fas fa-calendar-day"></i></span>
					<input type="date" class="form-control" id="income-date" name="IncomeDate" required value="@DateTime.Now.ToString("yyyy-MM-dd")">
				</div>
			</div>

			<!-- Số tiền -->
			<div class="d-flex align-items-center mb-1">
				<label for="income-amount" class="form-label small fw-bold mb-0 me-3 text-nowrap flex-shrink-0" style="width: 70px;">Số tiền <span class="text-danger">*</span></label>
				<div class="input-group input-group-static flex-grow-1">
					<input type="text" class="form-control" id="income-amount" name="Amount" placeholder="0" required inputmode="decimal" onkeyup="formatNumber(this)">
					<span class="input-group-text">VNĐ</span>
				</div>
			</div>

			<!-- Ghi chú -->
			<div class="d-flex align-items-center mb-3">
				<label for="income-note" class="form-label small fw-bold mb-0 me-3 text-nowrap flex-shrink-0" style="width: 70px;">Mô tả</label>
				<div class="input-group input-group-static flex-grow-1">
					<span class="input-group-text"><i class="fas fa-pencil-alt"></i></span>
					<input type="text" class="form-control" id="income-note" name="Note" placeholder="Mô tả nguồn thu ">
				</div>
			</div>

			<!-- Danh mục -->
			<div id="IncomeExpenseCateogry"></div>

			<input type="hidden" id="IncomeExpense-category-id" name="CategoryId" value="" required />

			<div class="mt-4">
				<button type="submit" class="btn btn-success w-100 py-2 fw-bold">
					<i class="fas fa-save me-2"></i> Thêm khoản thu
				</button>
			</div>
		</form>
	</div>
</div>


<style>
	/* Begin: Danh Mục */

	.btn-category.active {
		background-color: #0d6efd; /* Màu xanh dương khi active */
		color: white;
	}
	/* End: Danh Mục */

	/* Responsive adjustments */
	@@media (max-width: 767.98px) {
		.card-body {
			padding: 0.8rem !important;
		}

		.form-label {
			margin-bottom: 0.25rem !important;
		}
	}
</style>

<script>
	$(document).ready(function() {
		clickDanhMucDoiMau();
		EventGanIdChoCategory();
		addDataIncome();
		loadFormCategoryEI(1);
		loadFormHistory();
		updateSummary();
	});

	function formatNumber(input) {
		// Xóa tất cả các ký tự không phải số
		let value = input.value.replace(/[^\d]/g, '');

		// Thêm dấu chấm ngăn cách hàng nghìn
		value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

		// Cập nhật giá trị input
		input.value = value;
	}

	function clickDanhMucDoiMau() {
		// Sự kiện click cho tất cả các nút danh mục
		$(".btn-category").click(function() {
			// Xóa lớp "active" khỏi tất cả các nút
			$(".btn-category").removeClass("active");

			// Thêm lớp "active" vào nút đang được click
			$(this).addClass("active");
		});
	}

	function loadFormCategoryEI(type) {
		$.ajax({
			url: "/IncomeExpense/Category?type=" + type,
			type: "GET",
			success: function (data) {
				$("#IncomeExpenseCateogry").html(data);
			},
			error: function () {
				alert("Không tải được danh mục.");
			}
		});
	}

	function addDataIncome() {
		$("#addIncomeForm").submit(function (e) {
			e.preventDefault();

			var form = $(this);
			form.removeClass("was-validated");

			var categoryId = $("#IncomeExpense-category-id").val();
			var incomeDate = $("#income-date").val();
			var incomeAmount = $("#income-amount").val();
			var incomeNote = $("#income-note").val();

			// Gom lỗi vào 1 mảng
			var errors = [];

			if (!incomeDate) {
				errors.push("* Bạn chưa nhập ngày thu.");
			}
			if (!incomeAmount) {
				errors.push("* Bạn chưa nhập số tiền khoản thu.");
			}
			if (!incomeNote) {
				errors.push("* Bạn chưa nhập  mô tả khoản thu.");
			}
			if (!categoryId) {
				errors.push("* Bạn chưa chọn một danh mục khoản thu.");
			}

			// Nếu có lỗi thì hiển thị chung
			if (errors.length > 0) {
				var errorMessage = errors.join("<br>");
				showDialog(errorMessage);
				return;
			}

			// Chuẩn bị dữ liệu
			var formData = {
				Amount: parseFloat(incomeAmount.replace(/\./g, "")),
				Date: incomeDate,
				Description: $("#income-note").val(),
				CategoryId: categoryId,
				Type: "Income"
			};

			$.ajax({
				url: "/IncomeExpense/Save",
				type: "POST",
				data: formData,
				success: function (res) {
					form.trigger("reset");
					form.removeClass("was-validated");
					loadForm("income"); // Load lại danh sách
				},
				error: function (xhr) {
					form.addClass("was-validated");
					$(".field-validation-error").remove();
					$(".is-invalid").removeClass("is-invalid");

					if (xhr.responseJSON && xhr.responseJSON.errors) {
						let errors = xhr.responseJSON.errors;
						for (let key in errors) {
							let input = $("[name='" + key + "']");
							if (input.length > 0) {
								input.addClass("is-invalid");
								input.after(`<div class="field-validation-error text-danger">${errors[key]}</div>`);
							}
						}
					}
				}
			});
		});
	}

	function EventGanIdChoCategory() {
		// Do loadFormCategoryEI(2) có thể load thêm danh mục mới
		// nên phải dùng .on('click') để gán sự kiện động
		$(document).on("click", ".btn-category", function () {
			var categoryId = $(this).data("category-id"); // Lấy id
			$("#IncomeExpense-category-id").val(categoryId);    // Gán vào input hidden

			// Ẩn thông báo lỗi nếu có
			$("#category-validation-feedback").hide();

			// Đổi màu nút: clear tất cả, active cái được chọn
			$(".btn-category").removeClass("btn-primary").addClass("btn-light");
			$(this).removeClass("btn-light").addClass("btn-primary");
		});
	}

	function showDialog(message) {
		var dialogHtml = `
			<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="validationModalLabel">Thông báo</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
						</div>
						<div class="modal-body">
							${message}
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
						</div>
					</div>
				</div>
			</div>
		`;

		$("body").append(dialogHtml);

		var modal = new bootstrap.Modal(document.getElementById('validationModal'));
		modal.show();

		$('#validationModal').on('hidden.bs.modal', function () {
			$(this).remove(); // Xóa modal khỏi DOM khi đóng
		});
	}
</script>